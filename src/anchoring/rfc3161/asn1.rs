//! ASN.1 encoding/decoding for RFC 3161

#![allow(dead_code)]

use crate::anchoring::error::AnchorError;
use crate::anchoring::rfc3161::types::TsaResponse;
use rasn::types::{Any, Integer, ObjectIdentifier, OctetString};
use rasn::{AsnType, Decode, Decoder, Encode};
use rasn_cms::ContentInfo as CmsContentInfo;

/// SHA-256 OID: 2.16.840.1.101.3.4.2.1
#[allow(dead_code)]
const OID_SHA256: &[u64] = &[2, 16, 840, 1, 101, 3, 4, 2, 1];

/// CMS SignedData OID: 1.2.840.113549.1.7.2
const OID_SIGNED_DATA: &[u64] = &[1, 2, 840, 113549, 1, 7, 2];

/// id-ct-TSTInfo OID: 1.2.840.113549.1.9.16.1.4
const OID_TST_INFO: &[u64] = &[1, 2, 840, 113549, 1, 9, 16, 1, 4];

/// TimeStampReq (simplified structure for encoding)
#[allow(dead_code)]
#[derive(AsnType, Encode)]
struct TimeStampReq {
    version: Integer,
    message_imprint: MessageImprint,
    cert_req: bool,
}

/// MessageImprint structure
#[derive(AsnType, Encode)]
struct MessageImprint {
    hash_algorithm: AlgorithmIdentifier,
    hashed_message: OctetString,
}

/// AlgorithmIdentifier structure
#[derive(AsnType, Encode, Decode, Hash, PartialEq, Eq)]
struct AlgorithmIdentifier {
    algorithm: ObjectIdentifier,
    parameters: Option<Any>,
}

/// TSTInfo structure
#[derive(AsnType, Decode)]
struct TstInfo {
    version: Integer,
    policy: ObjectIdentifier,
    message_imprint: MessageImprintDecode,
    serial_number: Integer,
    gen_time: rasn::types::GeneralizedTime,
    accuracy: Option<Any>,
    ordering: Option<bool>,
    nonce: Option<Integer>,
    tsa: Option<Any>,
    extensions: Option<Any>,
}

/// MessageImprint for decoding
#[derive(AsnType, Decode)]
struct MessageImprintDecode {
    hash_algorithm: AlgorithmIdentifier,
    hashed_message: OctetString,
}

/// TimeStampResp (simplified structure for decoding)
///
/// RFC 3161: `TimeStampResp ::= SEQUENCE { status PKIStatusInfo, timeStampToken TimeStampToken OPTIONAL }`
/// where `TimeStampToken ::= ContentInfo` (CMS SignedData structure).
/// We use `rasn_cms::ContentInfo` to properly parse CMS structure with certificates.
#[derive(AsnType, Decode)]
struct TimeStampResp {
    status: PkiStatusInfo,
    time_stamp_token: Option<CmsContentInfo>,
}

/// PKIStatusInfo structure
#[derive(AsnType, Decode)]
struct PkiStatusInfo {
    status: Integer,
}

/// Build RFC 3161 TimeStampReq (DER encoded)
pub fn build_timestamp_request(hash: &[u8; 32]) -> Result<Vec<u8>, AnchorError> {
    let oid_vec: Vec<u32> = OID_SHA256.iter().map(|&x| x as u32).collect();
    let oid = ObjectIdentifier::new_unchecked(oid_vec.into());

    // Need to copy hash data to satisfy lifetime requirements
    let hash_vec = hash.to_vec();

    let req = TimeStampReq {
        version: Integer::from(1_i32),
        message_imprint: MessageImprint {
            hash_algorithm: AlgorithmIdentifier {
                algorithm: oid,
                parameters: None,
            },
            hashed_message: OctetString::from(hash_vec),
        },
        cert_req: true,
    };

    rasn::der::encode(&req).map_err(Into::into)
}

/// Parse RFC 3161 TimeStampResp (DER encoded)
///
/// Uses rasn-cms to properly parse CMS structures with certificates.
/// The rasn_cms::ContentInfo type correctly handles OPTIONAL certificates with implicit tags.
pub fn parse_timestamp_response(der: &[u8]) -> Result<TsaResponse, AnchorError> {
    let resp: TimeStampResp = rasn::der::decode(der)?;

    // Check status (0 = granted)
    // Note: Integer from rasn doesn't have to_i32, we need to check if it equals 0
    let status_is_zero = resp.status.status == Integer::from(0_i32);

    if !status_is_zero {
        return Err(AnchorError::ServiceError(
            "TSA returned non-zero status".into(),
        ));
    }

    let token = resp
        .time_stamp_token
        .ok_or_else(|| AnchorError::InvalidResponse("no token in response".into()))?;

    // Extract timestamp from token (simplified - in real impl parse TSTInfo)
    let timestamp = extract_timestamp_from_token(&token)?;

    // Store the raw DER bytes of the TimeStampToken (ContentInfo)
    let token_der = rasn::der::encode(&token)?;

    Ok(TsaResponse {
        token_der,
        timestamp,
    })
}

/// Extract timestamp from TimeStampToken
///
/// Parses CMS ContentInfo -> SignedData -> TSTInfo and extracts genTime.
fn extract_timestamp_from_token(token: &CmsContentInfo) -> Result<u64, AnchorError> {
    // Verify content_type is SignedData
    let signed_data_oid = ObjectIdentifier::new_unchecked(
        OID_SIGNED_DATA
            .iter()
            .map(|&x| x as u32)
            .collect::<Vec<_>>()
            .into(),
    );

    if token.content_type != signed_data_oid {
        return Err(AnchorError::InvalidResponse(
            "ContentInfo is not SignedData".into(),
        ));
    }

    // Decode SignedData from the content field
    let signed_data_bytes = rasn::der::encode(&token.content)?;
    let signed_data: rasn_cms::SignedData = rasn::der::decode(&signed_data_bytes)?;

    // Extract TSTInfo from encap_content_info
    let tst_info_oid = ObjectIdentifier::new_unchecked(
        OID_TST_INFO
            .iter()
            .map(|&x| x as u32)
            .collect::<Vec<_>>()
            .into(),
    );

    if signed_data.encap_content_info.content_type != tst_info_oid {
        return Err(AnchorError::InvalidResponse(
            "EncapsulatedContentInfo is not TSTInfo".into(),
        ));
    }

    let e_content = signed_data
        .encap_content_info
        .content
        .as_ref()
        .ok_or_else(|| AnchorError::InvalidResponse("Missing eContent in TSTInfo".into()))?;

    let tst_info: TstInfo = rasn::der::decode(e_content.as_ref())?;

    // Convert GeneralizedTime to Unix nanoseconds
    let unix_nanos = tst_info
        .gen_time
        .timestamp_nanos_opt()
        .ok_or_else(|| AnchorError::InvalidResponse("Timestamp out of range".into()))?;

    unix_nanos
        .try_into()
        .map_err(|_| AnchorError::InvalidResponse("Timestamp overflow".into()))
}

/// Verify message imprint in token matches expected hash
///
/// Extracts MessageImprint from TSTInfo and compares with expected hash.
pub fn verify_message_imprint(
    token_der: &[u8],
    expected_hash: &[u8; 32],
) -> Result<(), AnchorError> {
    // Decode ContentInfo from token
    let content_info: CmsContentInfo = rasn::der::decode(token_der)?;

    // Verify content_type is SignedData
    let signed_data_oid = ObjectIdentifier::new_unchecked(
        OID_SIGNED_DATA
            .iter()
            .map(|&x| x as u32)
            .collect::<Vec<_>>()
            .into(),
    );
    if content_info.content_type != signed_data_oid {
        return Err(AnchorError::InvalidResponse(
            "ContentInfo is not SignedData".into(),
        ));
    }

    // Decode SignedData from content
    let signed_data_bytes = rasn::der::encode(&content_info.content)?;
    let signed_data: rasn_cms::SignedData = rasn::der::decode(&signed_data_bytes)?;

    // Verify encap_content_info.content_type is TSTInfo
    let tst_info_oid = ObjectIdentifier::new_unchecked(
        OID_TST_INFO
            .iter()
            .map(|&x| x as u32)
            .collect::<Vec<_>>()
            .into(),
    );
    if signed_data.encap_content_info.content_type != tst_info_oid {
        return Err(AnchorError::InvalidResponse(
            "EncapsulatedContentInfo is not TSTInfo".into(),
        ));
    }

    // Extract and decode TSTInfo from e_content
    let e_content = signed_data
        .encap_content_info
        .content
        .as_ref()
        .ok_or_else(|| AnchorError::InvalidResponse("Missing eContent in TSTInfo".into()))?;

    let tst_info: TstInfo = rasn::der::decode(e_content.as_ref())?;

    // Verify hash algorithm is SHA-256
    let sha256_oid = ObjectIdentifier::new_unchecked(
        OID_SHA256
            .iter()
            .map(|&x| x as u32)
            .collect::<Vec<_>>()
            .into(),
    );
    if tst_info.message_imprint.hash_algorithm.algorithm != sha256_oid {
        return Err(AnchorError::InvalidResponse(
            "MessageImprint does not use SHA-256".into(),
        ));
    }

    // Compare hashed_message with expected hash
    let hashed_message = tst_info.message_imprint.hashed_message.as_ref();
    if hashed_message != expected_hash {
        return Err(AnchorError::InvalidResponse(
            "MessageImprint hash mismatch".into(),
        ));
    }

    Ok(())
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_build_request() {
        let hash = [0u8; 32];
        let result = build_timestamp_request(&hash);
        assert!(result.is_ok());
        let der = result.unwrap();
        assert!(!der.is_empty());
    }

    #[test]
    fn test_parse_real_freetsa_response() {
        // Real TSA response from FreeTSA (2026-01-11)
        // Input: SHA-256("test") = 954d5a49fd70d9b8bcdb35d252267829957f7ef7fa6c74f88419bdc5e82209f4
        const FREETSA_RESPONSE_HEX: &str = "3082155d30030201003082155406092a864886f70d010702a082154530821541020103310f300d060960864801650304020305003082018f060b2a864886f70d0109100104a082017e0482017a3082017602010106042a0304013031300d060960864801650304020105000420954d5a49fd70d9b8bcdb35d252267829957f7ef7fa6c74f88419bdc5e82209f40204026eb423180f32303236303131313030303131325a0101ff02090081c082603883d30da0820111a482010d308201093111300f060355040a13084672656520545341310c300a060355040b130354534131763074060355040d136d54686973206365727469666963617465206469676974616c6c79207369676e7320646f63756d656e747320616e642074696d65207374616d70207265717565737473206d616465207573696e672074686520667265657473612e6f7267206f6e6c696e65207365727669636573311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310b3009060355040613024445310f300d0603550408130642617965726ea082100830820801308205e9a003020102020900c1e986160da8e982300d06092a864886f70d01010d05003081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b3009060355040613024445301e170d3136303331333031353733395a170d3236303331313031353733395a308201093111300f060355040a13084672656520545341310c300a060355040b130354534131763074060355040d136d54686973206365727469666963617465206469676974616c6c79207369676e7320646f63756d656e747320616e642074696d65207374616d70207265717565737473206d616465207573696e672074686520667265657473612e6f7267206f6e6c696e65207365727669636573311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310b3009060355040613024445310f300d0603550408130642617965726e30820222300d06092a864886f70d01010105000382020f003082020a0282020100b591048c4e486f34e9dc08627fc2375162236984b82cb130beff517cfc38f84bce5c65a874dab2621ae0bce7e33563e0ede934fd5f8823159f07848808227460c1ed88261706f4281334359dfbb81bd1353fc179610af1a8c8c865dc00ea23b3a89be6bd03ba85a9ec827d60565905e22d6a584ed1380ae150280cee397e98a012f380464007862443bc077cb95f421af31712d9683cdb6dffbaf3c8ba5ba566ae523d459d6177346d4d840e27886b7c01c5b890d78a2e27bba8dd2f9a2812e157d62f921c65962548069dcdb7d06de181de0e9570d66f87220ce28b628ab55906f3ee0c210f7051e8f4858af8b9a92d09e46af2d9cba5bfcfad168cdf604491a4b06603b114caf7031f065e7eeefa53c575f3490c059d2e32ddc76ac4d4c4c710683b97fd1be591bc61055186d88f9a0391b307b6f91ed954daa36f9acd6a1e14aa2e4adf17464b54db18dbb6ffe30080246547370436ce4e77bae5de6fe0f3f9d6e7ffbeb461e794e92fb0951f8aae61a412cce9b21074635c8be327ae1a0f6b4a646eb0f8463bc63bf845530435d19e802511ec9f66c3496952d8becb69b0aa4d4c41f60515fe7dcbb89319cdda59ba6aea4be3ceae718e6fcb6ccd7db9fc50bb15b12f3665b0aa307289c2e6dd4b111ce48ba2d9efdb5a6b9a506069334fb34f6fc7ae330f0b34208aac80df3266fdd90465876ba2cb898d9505315b6e7b0203010001a38201db308201d730090603551d1304023000301d0603551d0e041604146e760b7b4e4f9ce160ca6d2ce927a2a294b37737301f0603551d23041830168014fa550d8c346651434cf7e7b3a76c95af7ae6a497300b0603551d0f0404030206c030160603551d250101ff040c300a06082b06010505070308306306082b0601050507010104573055302a06082b06010505073002861e687474703a2f2f7777772e667265657473612e6f72672f7473612e637274302706082b06010505073001861b687474703a2f2f7777772e667265657473612e6f72673a3235363030370603551d1f0430302e302ca02aa0288626687474703a2f2f7777772e667265657473612e6f72672f63726c2f726f6f745f63612e63726c3081c60603551d200481be3081bb3081b80601003081b2303306082b060105050702011627687474703a2f2f7777772e667265657473612e6f72672f667265657473615f6370732e68746d6c303206082b060105050702011626687474703a2f2f7777772e667265657473612e6f72672f667265657473615f6370732e706466304706082b06010505070202303b1a394672656554534120747275737465642074696d657374616d70696e6720536f6674776172652061732061205365727669636520285361615329300d06092a864886f70d01010d05000382020100a5c944e2c6fac0a14d930a7fd0a0b172b41fc1483c3e957c68a2bcd9b9764f1a950161fd72472d41a5eed277786203b5422240fb3a26cde176087b6fb1011df4cc19e2571aa4a051109665e94c46f50bd2adee6ac4137e251b25a39dabda451515d8ff9e07209e8ec20b7874f7e1a0ede7c00937fe84a334f8b3265ced2d8ed9df61396583677feb382c1ee3b23e6ea5f05df30de7b9f89005d25266f612f39c8b4f6daba6d7bfbac19632b90637329f52a6f066a10e43eaa81f849a6c5fe3fe8b5ea23275f687f2052e502ea6c30762a668cce07871dd8e97e315bba929e25589977a0a312ce96c5106b1437c779f2b361b182888f3ee8a234374fa063e956192627f7c431073965d1260928eba009e803429ae324cf96f042354f37bca5afddc79f79346ab388bfc79f01dc9861254ea6cc129941076b83d20556f3be51326837f2876f7833b370e7c3d410523827d4f53400c72218d75229ff10c6f8893a9a3a1c0c42bb4c898c13df41c7f6573b4fc56515971a610a7b0d2857c8225a9fb204eaceca2e8971aa1af87886a2ae3c72fe0a0aae842980a77bef16b92115458090d982b5946603764e75a0ad3d11454b9986f678b9ab6afe8497033ae3abfd4eb43b7bc9dee68815949e6481582a82e785277f2282107efe390200e0508acb8ea82ea2505276f3c9da2a3d3b4ad38bbf8842bda36fc2448291f558dc02dd1e0308207ff308205e7a003020102020900c1e986160da8e980300d06092a864886f70d01010d05003081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b3009060355040613024445301e170d3136303331333031353231335a170d3431303330373031353231335a3081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b300906035504061302444530820222300d06092a864886f70d01010105000382020f003082020a0282020100b6028e0e3032f11110d964cda94b9d0278e1942ae913aaa59907cda69793995bd9ac7e33bad9fe3704da1c01a98d21afe3f591a59d7067705167998f5016722e0ab462b21f439171d2cfcc4593f3735af794a5ab311f6c010c7898de33d75c4510ee76f4bd1d1498cf17d303f06a5dd9f796cc6ca9b657a56fe3ea4fefbe7ce6b6a18d3e35a30cee5ff170d1cf39a333d3fda8964d22db685b29e561be890f0aa845873b2e84ab26ab839ffe8fade9d23bb31e61d273cc9b880649185fabecfa0534600aba901b614e2e854582dea2226fc19cd7df52bed50d8777cd9988c053a3fc7dc3287a068a4ff12b713cd9803666e955385456ff38f80298cf6b93856e9224774a66cf1cdd11c2f8efd85203d7458b25664b13ed639cded4ff8113d6cc5353d2729473c3c307157c722aa5b5dd0bfb2d6c38b1b93749c881ec60026d08951b3824bd71bacbce473aebd636f0b918b4a2c8ff4694f07457af2d6f1cf82554d1770fd79ff5d314dcd104cddcabc94138056dfcf017e7eb8572fd52f70144f188da05f5823f58dd06297e7387bed2d772c13da8266601045fe412dd70986c0c987ba7344b9037387516d258e7885b51f8968b7f2601213bc4cb4c85f8ff0b84af6a988337cdfb81868f7ecf31dca6716d7ec2dd802c1672629e5c0052cb357dd29aafc43f615b3b1ff9d4e1ce08c71c73e1febb7dc56a33621329e9ed6c230203010001a382024e3082024a300c0603551d13040530030101ff300e0603551d0f0101ff0404030201c6301d0603551d0e04160414fa550d8c346651434cf7e7b3a76c95af7ae6a4973081ca0603551d230481c23081bf8014fa550d8c346651434cf7e7b3a76c95af7ae6a497a1819ba481983081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b3009060355040613024445820900c1e986160da8e98030330603551d1f042c302a3028a026a0248622687474703a2f2f7777772e667265657473612e6f72672f726f6f745f63612e63726c3081cf0603551d200481c73081c43081c1060a2b0601040181f22401013081b2303306082b060105050702011627687474703a2f2f7777772e667265657473612e6f72672f667265657473615f6370732e68746d6c303206082b060105050702011626687474703a2f2f7777772e667265657473612e6f72672f667265657473615f6370732e706466304706082b06010505070202303b1a394672656554534120747275737465642074696d657374616d70696e6720536f6674776172652061732061205365727669636520285361615329303706082b06010505070101042b3029302706082b06010505073001861b687474703a2f2f7777772e667265657473612e6f72673a32353630300d06092a864886f70d01010d0500038202010068af7ebf938562ef4ceb3b580be2faf6cc35a26772962f3d95901fa5630c87d09198984ce8a06a33f8a9c282ed9f1cb11ac6c23e17108ee4efce6fb294de95c133262255725522ca61971d4a3b7f78250dfb8d4aeec0fb1959b164100520b9c10e64c62662e4ad4d0abae2298fc948fc4e99e8d9e6b8fdbe4404121ec7c1422eacb2c9d7328e07396e60b4f3bb803ad4a555c80fefb53f85e7764a0a9fb4afc399f4cd2f5fbf587105c6081cf3d05337b6bb7d1b010b749f4888c912f3696ba1b6902d77b7dfc046c04a0cc1ec4f8d185e2da55dfb7bc2a2036c6219246a4f99ddbb6f1f829398f3b803dc0ad90dcb59bef4c27c77404b99043b78271867991152c399f12cbfc4c625adc096355ae44e342100ec517a502e2f06f940b8d43599bbc1154f8ae761a0b0d555fb4a1391d4f3420af8dbf12f2d7ddb9d77dce1537804074af175e4f2d6d55b34b5d6f7dcbdd31730af56480d4c0cff143f9e83bc151866d0ba0f0bbdc47fe27864176bbd6c1ab85df325edf777889bc4471bf3fa73e56cc591e8b160cda7b0786a1ec04ac3b24fa2e28d5d19e5e48004d5e166a83c82ec6fd54fb385ebaf7133a85b52de46db5244e1c34ae8d36e712f9fce0d493d7d3edd586c6198e3ec3e6e96346f417ac9f221e0aff33a8f6a0b1ef4c023630b76adaa8d91433825ecc41c49a5b98b181c7da30e997ab954c73c2cd805afda993182038a308203860201013081a33081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b3009060355040613024445020900c1e986160da8e982300d06096086480165030402030500a081b8301a06092a864886f70d010903310d060b2a864886f70d0109100104301c06092a864886f70d010905310f170d3236303131313030303131325a302b060b2a864886f70d010910020c311c301a301830160414916da3d860ecca82e34bc59d1793e7e968875f14304f06092a864886f70d01090431420440044f479a6d1240954966f51b86e85ef72ea23c12a0a3dc502901adca336334339ebf18f39b7708cd60780514841423adf531b44b3795699ca8ecf9a9325d3c53300d06092a864886f70d0101010500048202003f09255516f561f9f09786cb3abd61aca90f6217f01145b1e9107be8fcd17c0d3334f056c4e3c9871ef58b63c8e52c008aecf8bc345fc7242b22091c9b0020ed37626450c93a65d130a57a8f473709dbf458b0a9fea1e5564d4efd04bf0c935759be75543c6a3e59c9c42eb25cc89bb8491794b5aeaa598c03023118e07b71ae1e1b6236c2f9e8f252b73e993de3a6c9a99622d919b2abfedc77ffb0d40d85641ef40054f2fc1f15d8bf24b4d02801f16fc1a8c4d9b4cd0806b02b0270225d022fcc6453d17e55123a3fa1144cb6aa6e4652fecfb1290105b198a3bd98f9d2da733dbb5d4d31accd89a1feb065f9fba28458c883adba81dbb665299ffccdba1845e620854866939b84ad76f4dd76f1bcc45b5ae0316802c24d4cc3d0244fcf41bfe23d9edd8272d86c5ed1560cd7f7ed1314c6d7f78d9b31ea0df30f5a5784e59a876f1e0a389c9a16010e5f4ddb91874c9699517bf34016ae64e20fbddc8dd6db1ff68608d14ce073bc4725dfe70ea22306fa11dd0547b1b3a4ef78bea22682f63d907e3a508346ef4f2f0a9af84aa6b6ac833ca9d6e386a9a811b251a9ea3c774eaffae9a90aa75ae5af75cff823cbe65a999b99cfc3088445e9a011d164da17f1b6862dd2ce1cd95237b56fbe780e13e8833504899d8062fa2423f990e3361ee702d75c5e0a061fce4acf390a3423397365902d86ac4c77644b575415ebc5";

        let der = hex::decode(FREETSA_RESPONSE_HEX).expect("valid hex");
        let result = parse_timestamp_response(&der);

        assert!(result.is_ok(), "Failed to parse: {:?}", result.err());

        let response = result.unwrap();
        assert!(!response.token_der.is_empty());
        assert!(response.timestamp > 0);
    }

    #[test]
    fn test_build_request_with_different_hashes() {
        let hash1 = [0xAAu8; 32];
        let hash2 = [0xBBu8; 32];

        let der1 = build_timestamp_request(&hash1).unwrap();
        let der2 = build_timestamp_request(&hash2).unwrap();

        assert!(!der1.is_empty());
        assert!(!der2.is_empty());
        assert_ne!(der1, der2); // Different hashes produce different requests
    }

    #[test]
    fn test_parse_response_invalid_der() {
        let invalid_der = vec![0xFF, 0xFF, 0xFF];
        let result = parse_timestamp_response(&invalid_der);
        assert!(result.is_err());
    }

    #[test]
    fn test_verify_message_imprint_with_real_response() {
        const FREETSA_RESPONSE_HEX: &str = "3082155d30030201003082155406092a864886f70d010702a082154530821541020103310f300d060960864801650304020305003082018f060b2a864886f70d0109100104a082017e0482017a3082017602010106042a0304013031300d060960864801650304020105000420954d5a49fd70d9b8bcdb35d252267829957f7ef7fa6c74f88419bdc5e82209f40204026eb423180f32303236303131313030303131325a0101ff02090081c082603883d30da0820111a482010d308201093111300f060355040a13084672656520545341310c300a060355040b130354534131763074060355040d136d54686973206365727469666963617465206469676974616c6c79207369676e7320646f63756d656e747320616e642074696d65207374616d70207265717565737473206d616465207573696e672074686520667265657473612e6f7267206f6e6c696e65207365727669636573311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310b3009060355040613024445310f300d0603550408130642617965726ea082100830820801308205e9a003020102020900c1e986160da8e982300d06092a864886f70d01010d05003081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b3009060355040613024445301e170d3136303331333031353733395a170d3236303331313031353733395a308201093111300f060355040a13084672656520545341310c300a060355040b130354534131763074060355040d136d54686973206365727469666963617465206469676974616c6c79207369676e7320646f63756d656e747320616e642074696d65207374616d70207265717565737473206d616465207573696e672074686520667265657473612e6f7267206f6e6c696e65207365727669636573311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310b3009060355040613024445310f300d0603550408130642617965726e30820222300d06092a864886f70d01010105000382020f003082020a0282020100b591048c4e486f34e9dc08627fc2375162236984b82cb130beff517cfc38f84bce5c65a874dab2621ae0bce7e33563e0ede934fd5f8823159f07848808227460c1ed88261706f4281334359dfbb81bd1353fc179610af1a8c8c865dc00ea23b3a89be6bd03ba85a9ec827d60565905e22d6a584ed1380ae150280cee397e98a012f380464007862443bc077cb95f421af31712d9683cdb6dffbaf3c8ba5ba566ae523d459d6177346d4d840e27886b7c01c5b890d78a2e27bba8dd2f9a2812e157d62f921c65962548069dcdb7d06de181de0e9570d66f87220ce28b628ab55906f3ee0c210f7051e8f4858af8b9a92d09e46af2d9cba5bfcfad168cdf604491a4b06603b114caf7031f065e7eeefa53c575f3490c059d2e32ddc76ac4d4c4c710683b97fd1be591bc61055186d88f9a0391b307b6f91ed954daa36f9acd6a1e14aa2e4adf17464b54db18dbb6ffe30080246547370436ce4e77bae5de6fe0f3f9d6e7ffbeb461e794e92fb0951f8aae61a412cce9b21074635c8be327ae1a0f6b4a646eb0f8463bc63bf845530435d19e802511ec9f66c3496952d8becb69b0aa4d4c41f60515fe7dcbb89319cdda59ba6aea4be3ceae718e6fcb6ccd7db9fc50bb15b12f3665b0aa307289c2e6dd4b111ce48ba2d9efdb5a6b9a506069334fb34f6fc7ae330f0b34208aac80df3266fdd90465876ba2cb898d9505315b6e7b0203010001a38201db308201d730090603551d1304023000301d0603551d0e041604146e760b7b4e4f9ce160ca6d2ce927a2a294b37737301f0603551d23041830168014fa550d8c346651434cf7e7b3a76c95af7ae6a497300b0603551d0f0404030206c030160603551d250101ff040c300a06082b06010505070308306306082b0601050507010104573055302a06082b06010505073002861e687474703a2f2f7777772e667265657473612e6f72672f7473612e637274302706082b06010505073001861b687474703a2f2f7777772e667265657473612e6f72673a3235363030370603551d1f0430302e302ca02aa0288626687474703a2f2f7777772e667265657473612e6f72672f63726c2f726f6f745f63612e63726c3081c60603551d200481be3081bb3081b80601003081b2303306082b060105050702011627687474703a2f2f7777772e667265657473612e6f72672f667265657473615f6370732e68746d6c303206082b060105050702011626687474703a2f2f7777772e667265657473612e6f72672f667265657473615f6370732e706466304706082b06010505070202303b1a394672656554534120747275737465642074696d657374616d70696e6720536f6674776172652061732061205365727669636520285361615329300d06092a864886f70d01010d05000382020100a5c944e2c6fac0a14d930a7fd0a0b172b41fc1483c3e957c68a2bcd9b9764f1a950161fd72472d41a5eed277786203b5422240fb3a26cde176087b6fb1011df4cc19e2571aa4a051109665e94c46f50bd2adee6ac4137e251b25a39dabda451515d8ff9e07209e8ec20b7874f7e1a0ede7c00937fe84a334f8b3265ced2d8ed9df61396583677feb382c1ee3b23e6ea5f05df30de7b9f89005d25266f612f39c8b4f6daba6d7bfbac19632b90637329f52a6f066a10e43eaa81f849a6c5fe3fe8b5ea23275f687f2052e502ea6c30762a668cce07871dd8e97e315bba929e25589977a0a312ce96c5106b1437c779f2b361b182888f3ee8a234374fa063e956192627f7c431073965d1260928eba009e803429ae324cf96f042354f37bca5afddc79f79346ab388bfc79f01dc9861254ea6cc129941076b83d20556f3be51326837f2876f7833b370e7c3d410523827d4f53400c72218d75229ff10c6f8893a9a3a1c0c42bb4c898c13df41c7f6573b4fc56515971a610a7b0d2857c8225a9fb204eaceca2e8971aa1af87886a2ae3c72fe0a0aae842980a77bef16b92115458090d982b5946603764e75a0ad3d11454b9986f678b9ab6afe8497033ae3abfd4eb43b7bc9dee68815949e6481582a82e785277f2282107efe390200e0508acb8ea82ea2505276f3c9da2a3d3b4ad38bbf8842bda36fc2448291f558dc02dd1e0308207ff308205e7a003020102020900c1e986160da8e980300d06092a864886f70d01010d05003081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b3009060355040613024445301e170d3136303331333031353231335a170d3431303330373031353231335a3081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b300906035504061302444530820222300d06092a864886f70d01010105000382020f003082020a0282020100b6028e0e3032f11110d964cda94b9d0278e1942ae913aaa59907cda69793995bd9ac7e33bad9fe3704da1c01a98d21afe3f591a59d7067705167998f5016722e0ab462b21f439171d2cfcc4593f3735af794a5ab311f6c010c7898de33d75c4510ee76f4bd1d1498cf17d303f06a5dd9f796cc6ca9b657a56fe3ea4fefbe7ce6b6a18d3e35a30cee5ff170d1cf39a333d3fda8964d22db685b29e561be890f0aa845873b2e84ab26ab839ffe8fade9d23bb31e61d273cc9b880649185fabecfa0534600aba901b614e2e854582dea2226fc19cd7df52bed50d8777cd9988c053a3fc7dc3287a068a4ff12b713cd9803666e955385456ff38f80298cf6b93856e9224774a66cf1cdd11c2f8efd85203d7458b25664b13ed639cded4ff8113d6cc5353d2729473c3c307157c722aa5b5dd0bfb2d6c38b1b93749c881ec60026d08951b3824bd71bacbce473aebd636f0b918b4a2c8ff4694f07457af2d6f1cf82554d1770fd79ff5d314dcd104cddcabc94138056dfcf017e7eb8572fd52f70144f188da05f5823f58dd06297e7387bed2d772c13da8266601045fe412dd70986c0c987ba7344b9037387516d258e7885b51f8968b7f2601213bc4cb4c85f8ff0b84af6a988337cdfb81868f7ecf31dca6716d7ec2dd802c1672629e5c0052cb357dd29aafc43f615b3b1ff9d4e1ce08c71c73e1febb7dc56a33621329e9ed6c230203010001a382024e3082024a300c0603551d13040530030101ff300e0603551d0f0101ff0404030201c6301d0603551d0e04160414fa550d8c346651434cf7e7b3a76c95af7ae6a4973081ca0603551d230481c23081bf8014fa550d8c346651434cf7e7b3a76c95af7ae6a497a1819ba481983081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b3009060355040613024445820900c1e986160da8e98030330603551d1f042c302a3028a026a0248622687474703a2f2f7777772e667265657473612e6f72672f726f6f745f63612e63726c3081cf0603551d200481c73081c43081c1060a2b0601040181f22401013081b2303306082b060105050702011627687474703a2f2f7777772e667265657473612e6f72672f667265657473615f6370732e68746d6c303206082b060105050702011626687474703a2f2f7777772e667265657473612e6f72672f667265657473615f6370732e706466304706082b06010505070202303b1a394672656554534120747275737465642074696d657374616d70696e6720536f6674776172652061732061205365727669636520285361615329303706082b06010505070101042b3029302706082b06010505073001861b687474703a2f2f7777772e667265657473612e6f72673a32353630300d06092a864886f70d01010d0500038202010068af7ebf938562ef4ceb3b580be2faf6cc35a26772962f3d95901fa5630c87d09198984ce8a06a33f8a9c282ed9f1cb11ac6c23e17108ee4efce6fb294de95c133262255725522ca61971d4a3b7f78250dfb8d4aeec0fb1959b164100520b9c10e64c62662e4ad4d0abae2298fc948fc4e99e8d9e6b8fdbe4404121ec7c1422eacb2c9d7328e07396e60b4f3bb803ad4a555c80fefb53f85e7764a0a9fb4afc399f4cd2f5fbf587105c6081cf3d05337b6bb7d1b010b749f4888c912f3696ba1b6902d77b7dfc046c04a0cc1ec4f8d185e2da55dfb7bc2a2036c6219246a4f99ddbb6f1f829398f3b803dc0ad90dcb59bef4c27c77404b99043b78271867991152c399f12cbfc4c625adc096355ae44e342100ec517a502e2f06f940b8d43599bbc1154f8ae761a0b0d555fb4a1391d4f3420af8dbf12f2d7ddb9d77dce1537804074af175e4f2d6d55b34b5d6f7dcbdd31730af56480d4c0cff143f9e83bc151866d0ba0f0bbdc47fe27864176bbd6c1ab85df325edf777889bc4471bf3fa73e56cc591e8b160cda7b0786a1ec04ac3b24fa2e28d5d19e5e48004d5e166a83c82ec6fd54fb385ebaf7133a85b52de46db5244e1c34ae8d36e712f9fce0d493d7d3edd586c6198e3ec3e6e96346f417ac9f221e0aff33a8f6a0b1ef4c023630b76adaa8d91433825ecc41c49a5b98b181c7da30e997ab954c73c2cd805afda993182038a308203860201013081a33081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b3009060355040613024445020900c1e986160da8e982300d06096086480165030402030500a081b8301a06092a864886f70d010903310d060b2a864886f70d0109100104301c06092a864886f70d010905310f170d3236303131313030303131325a302b060b2a864886f70d010910020c311c301a301830160414916da3d860ecca82e34bc59d1793e7e968875f14304f06092a864886f70d01090431420440044f479a6d1240954966f51b86e85ef72ea23c12a0a3dc502901adca336334339ebf18f39b7708cd60780514841423adf531b44b3795699ca8ecf9a9325d3c53300d06092a864886f70d0101010500048202003f09255516f561f9f09786cb3abd61aca90f6217f01145b1e9107be8fcd17c0d3334f056c4e3c9871ef58b63c8e52c008aecf8bc345fc7242b22091c9b0020ed37626450c93a65d130a57a8f473709dbf458b0a9fea1e5564d4efd04bf0c935759be75543c6a3e59c9c42eb25cc89bb8491794b5aeaa598c03023118e07b71ae1e1b6236c2f9e8f252b73e993de3a6c9a99622d919b2abfedc77ffb0d40d85641ef40054f2fc1f15d8bf24b4d02801f16fc1a8c4d9b4cd0806b02b0270225d022fcc6453d17e55123a3fa1144cb6aa6e4652fecfb1290105b198a3bd98f9d2da733dbb5d4d31accd89a1feb065f9fba28458c883adba81dbb665299ffccdba1845e620854866939b84ad76f4dd76f1bcc45b5ae0316802c24d4cc3d0244fcf41bfe23d9edd8272d86c5ed1560cd7f7ed1314c6d7f78d9b31ea0df30f5a5784e59a876f1e0a389c9a16010e5f4ddb91874c9699517bf34016ae64e20fbddc8dd6db1ff68608d14ce073bc4725dfe70ea22306fa11dd0547b1b3a4ef78bea22682f63d907e3a508346ef4f2f0a9af84aa6b6ac833ca9d6e386a9a811b251a9ea3c774eaffae9a90aa75ae5af75cff823cbe65a999b99cfc3088445e9a011d164da17f1b6862dd2ce1cd95237b56fbe780e13e8833504899d8062fa2423f990e3361ee702d75c5e0a061fce4acf390a3423397365902d86ac4c77644b575415ebc5";

        let der = hex::decode(FREETSA_RESPONSE_HEX).expect("valid hex");
        let response = parse_timestamp_response(&der).unwrap();

        // Expected hash: SHA-256("test")
        let expected_hash =
            hex::decode("954d5a49fd70d9b8bcdb35d252267829957f7ef7fa6c74f88419bdc5e82209f4")
                .unwrap();
        let mut hash_array = [0u8; 32];
        hash_array.copy_from_slice(&expected_hash);

        // Verify should pass with correct hash
        let result = verify_message_imprint(&response.token_der, &hash_array);
        assert!(result.is_ok());
    }

    #[test]
    fn test_verify_message_imprint_wrong_hash() {
        const FREETSA_RESPONSE_HEX: &str = "3082155d30030201003082155406092a864886f70d010702a082154530821541020103310f300d060960864801650304020305003082018f060b2a864886f70d0109100104a082017e0482017a3082017602010106042a0304013031300d060960864801650304020105000420954d5a49fd70d9b8bcdb35d252267829957f7ef7fa6c74f88419bdc5e82209f40204026eb423180f32303236303131313030303131325a0101ff02090081c082603883d30da0820111a482010d308201093111300f060355040a13084672656520545341310c300a060355040b130354534131763074060355040d136d54686973206365727469666963617465206469676974616c6c79207369676e7320646f63756d656e747320616e642074696d65207374616d70207265717565737473206d616465207573696e672074686520667265657473612e6f7267206f6e6c696e65207365727669636573311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310b3009060355040613024445310f300d0603550408130642617965726ea082100830820801308205e9a003020102020900c1e986160da8e982300d06092a864886f70d01010d05003081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b3009060355040613024445301e170d3136303331333031353733395a170d3236303331313031353733395a308201093111300f060355040a13084672656520545341310c300a060355040b130354534131763074060355040d136d54686973206365727469666963617465206469676974616c6c79207369676e7320646f63756d656e747320616e642074696d65207374616d70207265717565737473206d616465207573696e672074686520667265657473612e6f7267206f6e6c696e65207365727669636573311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310b3009060355040613024445310f300d0603550408130642617965726e30820222300d06092a864886f70d01010105000382020f003082020a0282020100b591048c4e486f34e9dc08627fc2375162236984b82cb130beff517cfc38f84bce5c65a874dab2621ae0bce7e33563e0ede934fd5f8823159f07848808227460c1ed88261706f4281334359dfbb81bd1353fc179610af1a8c8c865dc00ea23b3a89be6bd03ba85a9ec827d60565905e22d6a584ed1380ae150280cee397e98a012f380464007862443bc077cb95f421af31712d9683cdb6dffbaf3c8ba5ba566ae523d459d6177346d4d840e27886b7c01c5b890d78a2e27bba8dd2f9a2812e157d62f921c65962548069dcdb7d06de181de0e9570d66f87220ce28b628ab55906f3ee0c210f7051e8f4858af8b9a92d09e46af2d9cba5bfcfad168cdf604491a4b06603b114caf7031f065e7eeefa53c575f3490c059d2e32ddc76ac4d4c4c710683b97fd1be591bc61055186d88f9a0391b307b6f91ed954daa36f9acd6a1e14aa2e4adf17464b54db18dbb6ffe30080246547370436ce4e77bae5de6fe0f3f9d6e7ffbeb461e794e92fb0951f8aae61a412cce9b21074635c8be327ae1a0f6b4a646eb0f8463bc63bf845530435d19e802511ec9f66c3496952d8becb69b0aa4d4c41f60515fe7dcbb89319cdda59ba6aea4be3ceae718e6fcb6ccd7db9fc50bb15b12f3665b0aa307289c2e6dd4b111ce48ba2d9efdb5a6b9a506069334fb34f6fc7ae330f0b34208aac80df3266fdd90465876ba2cb898d9505315b6e7b0203010001a38201db308201d730090603551d1304023000301d0603551d0e041604146e760b7b4e4f9ce160ca6d2ce927a2a294b37737301f0603551d23041830168014fa550d8c346651434cf7e7b3a76c95af7ae6a497300b0603551d0f0404030206c030160603551d250101ff040c300a06082b06010505070308306306082b0601050507010104573055302a06082b06010505073002861e687474703a2f2f7777772e667265657473612e6f72672f7473612e637274302706082b06010505073001861b687474703a2f2f7777772e667265657473612e6f72673a3235363030370603551d1f0430302e302ca02aa0288626687474703a2f2f7777772e667265657473612e6f72672f63726c2f726f6f745f63612e63726c3081c60603551d200481be3081bb3081b80601003081b2303306082b060105050702011627687474703a2f2f7777772e667265657473612e6f72672f667265657473615f6370732e68746d6c303206082b060105050702011626687474703a2f2f7777772e667265657473612e6f72672f667265657473615f6370732e706466304706082b06010505070202303b1a394672656554534120747275737465642074696d657374616d70696e6720536f6674776172652061732061205365727669636520285361615329300d06092a864886f70d01010d05000382020100a5c944e2c6fac0a14d930a7fd0a0b172b41fc1483c3e957c68a2bcd9b9764f1a950161fd72472d41a5eed277786203b5422240fb3a26cde176087b6fb1011df4cc19e2571aa4a051109665e94c46f50bd2adee6ac4137e251b25a39dabda451515d8ff9e07209e8ec20b7874f7e1a0ede7c00937fe84a334f8b3265ced2d8ed9df61396583677feb382c1ee3b23e6ea5f05df30de7b9f89005d25266f612f39c8b4f6daba6d7bfbac19632b90637329f52a6f066a10e43eaa81f849a6c5fe3fe8b5ea23275f687f2052e502ea6c30762a668cce07871dd8e97e315bba929e25589977a0a312ce96c5106b1437c779f2b361b182888f3ee8a234374fa063e956192627f7c431073965d1260928eba009e803429ae324cf96f042354f37bca5afddc79f79346ab388bfc79f01dc9861254ea6cc129941076b83d20556f3be51326837f2876f7833b370e7c3d410523827d4f53400c72218d75229ff10c6f8893a9a3a1c0c42bb4c898c13df41c7f6573b4fc56515971a610a7b0d2857c8225a9fb204eaceca2e8971aa1af87886a2ae3c72fe0a0aae842980a77bef16b92115458090d982b5946603764e75a0ad3d11454b9986f678b9ab6afe8497033ae3abfd4eb43b7bc9dee68815949e6481582a82e785277f2282107efe390200e0508acb8ea82ea2505276f3c9da2a3d3b4ad38bbf8842bda36fc2448291f558dc02dd1e0308207ff308205e7a003020102020900c1e986160da8e980300d06092a864886f70d01010d05003081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b3009060355040613024445301e170d3136303331333031353231335a170d3431303330373031353231335a3081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b300906035504061302444530820222300d06092a864886f70d01010105000382020f003082020a0282020100b6028e0e3032f11110d964cda94b9d0278e1942ae913aaa59907cda69793995bd9ac7e33bad9fe3704da1c01a98d21afe3f591a59d7067705167998f5016722e0ab462b21f439171d2cfcc4593f3735af794a5ab311f6c010c7898de33d75c4510ee76f4bd1d1498cf17d303f06a5dd9f796cc6ca9b657a56fe3ea4fefbe7ce6b6a18d3e35a30cee5ff170d1cf39a333d3fda8964d22db685b29e561be890f0aa845873b2e84ab26ab839ffe8fade9d23bb31e61d273cc9b880649185fabecfa0534600aba901b614e2e854582dea2226fc19cd7df52bed50d8777cd9988c053a3fc7dc3287a068a4ff12b713cd9803666e955385456ff38f80298cf6b93856e9224774a66cf1cdd11c2f8efd85203d7458b25664b13ed639cded4ff8113d6cc5353d2729473c3c307157c722aa5b5dd0bfb2d6c38b1b93749c881ec60026d08951b3824bd71bacbce473aebd636f0b918b4a2c8ff4694f07457af2d6f1cf82554d1770fd79ff5d314dcd104cddcabc94138056dfcf017e7eb8572fd52f70144f188da05f5823f58dd06297e7387bed2d772c13da8266601045fe412dd70986c0c987ba7344b9037387516d258e7885b51f8968b7f2601213bc4cb4c85f8ff0b84af6a988337cdfb81868f7ecf31dca6716d7ec2dd802c1672629e5c0052cb357dd29aafc43f615b3b1ff9d4e1ce08c71c73e1febb7dc56a33621329e9ed6c230203010001a382024e3082024a300c0603551d13040530030101ff300e0603551d0f0101ff0404030201c6301d0603551d0e04160414fa550d8c346651434cf7e7b3a76c95af7ae6a4973081ca0603551d230481c23081bf8014fa550d8c346651434cf7e7b3a76c95af7ae6a497a1819ba481983081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b3009060355040613024445820900c1e986160da8e98030330603551d1f042c302a3028a026a0248622687474703a2f2f7777772e667265657473612e6f72672f726f6f745f63612e63726c3081cf0603551d200481c73081c43081c1060a2b0601040181f22401013081b2303306082b060105050702011627687474703a2f2f7777772e667265657473612e6f72672f667265657473615f6370732e68746d6c303206082b060105050702011626687474703a2f2f7777772e667265657473612e6f72672f667265657473615f6370732e706466304706082b06010505070202303b1a394672656554534120747275737465642074696d657374616d70696e6720536f6674776172652061732061205365727669636520285361615329303706082b06010505070101042b3029302706082b06010505073001861b687474703a2f2f7777772e667265657473612e6f72673a32353630300d06092a864886f70d01010d0500038202010068af7ebf938562ef4ceb3b580be2faf6cc35a26772962f3d95901fa5630c87d09198984ce8a06a33f8a9c282ed9f1cb11ac6c23e17108ee4efce6fb294de95c133262255725522ca61971d4a3b7f78250dfb8d4aeec0fb1959b164100520b9c10e64c62662e4ad4d0abae2298fc948fc4e99e8d9e6b8fdbe4404121ec7c1422eacb2c9d7328e07396e60b4f3bb803ad4a555c80fefb53f85e7764a0a9fb4afc399f4cd2f5fbf587105c6081cf3d05337b6bb7d1b010b749f4888c912f3696ba1b6902d77b7dfc046c04a0cc1ec4f8d185e2da55dfb7bc2a2036c6219246a4f99ddbb6f1f829398f3b803dc0ad90dcb59bef4c27c77404b99043b78271867991152c399f12cbfc4c625adc096355ae44e342100ec517a502e2f06f940b8d43599bbc1154f8ae761a0b0d555fb4a1391d4f3420af8dbf12f2d7ddb9d77dce1537804074af175e4f2d6d55b34b5d6f7dcbdd31730af56480d4c0cff143f9e83bc151866d0ba0f0bbdc47fe27864176bbd6c1ab85df325edf777889bc4471bf3fa73e56cc591e8b160cda7b0786a1ec04ac3b24fa2e28d5d19e5e48004d5e166a83c82ec6fd54fb385ebaf7133a85b52de46db5244e1c34ae8d36e712f9fce0d493d7d3edd586c6198e3ec3e6e96346f417ac9f221e0aff33a8f6a0b1ef4c023630b76adaa8d91433825ecc41c49a5b98b181c7da30e997ab954c73c2cd805afda993182038a308203860201013081a33081953111300f060355040a130846726565205453413110300e060355040b1307526f6f74204341311830160603550403130f7777772e667265657473612e6f72673122302006092a864886f70d0109011613627573696c657a617340676d61696c2e636f6d3112301006035504071309577565727a62757267310f300d0603550408130642617965726e310b3009060355040613024445020900c1e986160da8e982300d06096086480165030402030500a081b8301a06092a864886f70d010903310d060b2a864886f70d0109100104301c06092a864886f70d010905310f170d3236303131313030303131325a302b060b2a864886f70d010910020c311c301a301830160414916da3d860ecca82e34bc59d1793e7e968875f14304f06092a864886f70d01090431420440044f479a6d1240954966f51b86e85ef72ea23c12a0a3dc502901adca336334339ebf18f39b7708cd60780514841423adf531b44b3795699ca8ecf9a9325d3c53300d06092a864886f70d0101010500048202003f09255516f561f9f09786cb3abd61aca90f6217f01145b1e9107be8fcd17c0d3334f056c4e3c9871ef58b63c8e52c008aecf8bc345fc7242b22091c9b0020ed37626450c93a65d130a57a8f473709dbf458b0a9fea1e5564d4efd04bf0c935759be75543c6a3e59c9c42eb25cc89bb8491794b5aeaa598c03023118e07b71ae1e1b6236c2f9e8f252b73e993de3a6c9a99622d919b2abfedc77ffb0d40d85641ef40054f2fc1f15d8bf24b4d02801f16fc1a8c4d9b4cd0806b02b0270225d022fcc6453d17e55123a3fa1144cb6aa6e4652fecfb1290105b198a3bd98f9d2da733dbb5d4d31accd89a1feb065f9fba28458c883adba81dbb665299ffccdba1845e620854866939b84ad76f4dd76f1bcc45b5ae0316802c24d4cc3d0244fcf41bfe23d9edd8272d86c5ed1560cd7f7ed1314c6d7f78d9b31ea0df30f5a5784e59a876f1e0a389c9a16010e5f4ddb91874c9699517bf34016ae64e20fbddc8dd6db1ff68608d14ce073bc4725dfe70ea22306fa11dd0547b1b3a4ef78bea22682f63d907e3a508346ef4f2f0a9af84aa6b6ac833ca9d6e386a9a811b251a9ea3c774eaffae9a90aa75ae5af75cff823cbe65a999b99cfc3088445e9a011d164da17f1b6862dd2ce1cd95237b56fbe780e13e8833504899d8062fa2423f990e3361ee702d75c5e0a061fce4acf390a3423397365902d86ac4c77644b575415ebc5";

        let der = hex::decode(FREETSA_RESPONSE_HEX).expect("valid hex");
        let response = parse_timestamp_response(&der).unwrap();

        // Wrong hash
        let wrong_hash = [0xFFu8; 32];

        // Verify should fail with wrong hash
        let result = verify_message_imprint(&response.token_der, &wrong_hash);
        assert!(result.is_err());
        assert!(result
            .unwrap_err()
            .to_string()
            .contains("MessageImprint hash mismatch"));
    }

    #[test]
    fn test_verify_message_imprint_invalid_token() {
        let invalid_token = vec![0xFF, 0xFF, 0xFF];
        let hash = [0u8; 32];
        let result = verify_message_imprint(&invalid_token, &hash);
        assert!(result.is_err());
    }
}
